let lastTimestamp,santaX,santaY,sceneOffset,_status="waiting",score=0,platforms=[],sticks=[],trees=[],clouds=[],audioCtx=null;const config={canvasWidth:375,canvasHeight:375,platformHeight:100,santaDistanceFromEdge:10,paddingX:100,perfectAreaSize:10,backgroundSpeedMultiplier:.2,speed:4,santaWidth:17,santaHeight:30},colours={lightBg:"#62AFB9",medBg:"#004700",darkBg:"#0D5B66",lightHill:"#ECFFDC",medHill:"#34A65F",darkHill:"#1B5E20",platform:"#9B4546",platformTop:"#620E0E",em:"#CC231E",skin:"#CF6D60"},hills=[{baseHeight:120,amplitude:20,stretch:.5,colour:colours.lightHill},{baseHeight:100,amplitude:10,stretch:1,colour:colours.medHill},{baseHeight:70,amplitude:20,stretch:.5,colour:colours.darkHill}],scoreElement=createElementStyle("div",`position:absolute;top:1.5em;font-size:5em;font-weight:900;text-shadow:${addShadow(colours.darkHill,7)}`),canvas=createElementStyle("canvas"),introductionElement=createElementStyle("div","font-size:1.2em;position:absolute;text-align:center;transition:opacity 2s;width:250px","Hold to grow the candy stick.<br>Let go to drop it.<br>Help Santa cross! üéÖüèª"),perfectElement=createElementStyle("div","position:absolute;opacity:0;transition:opacity 2s","Double Score"),restartButton=createElementStyle("button",`width:120px;height:120px;position:absolute;border-radius:50%;color:white;background-color:${colours.em};border:none;font-weight:700;font-size:1.2em;display:none;cursor:pointer`,"RESTART");for(let t=0;t<=50;t++)createElementStyle("i",`font-size: ${3*Math.random()}em;left: ${100*Math.random()}%; animation-delay: ${10*Math.random()}s, ${2*Math.random()}s`,".");canvas.width=window.innerWidth,canvas.height=window.innerHeight;const ctx=canvas.getContext("2d");function resetGame(){_status="waiting",lastTimestamp=void 0,sceneOffset=0,score=0,introductionElement.style.opacity=1,perfectElement.style.opacity=0,restartButton.style.display="none",scoreElement.innerText=score,platforms=[{x:50,w:50}],santaX=platforms[0].x+platforms[0].w-config.santaDistanceFromEdge,santaY=0,sticks=[{x:platforms[0].x+platforms[0].w,length:0,rotation:0}],trees=[],clouds=[];for(let t=0;t<=20;t++)t<=3&&generatePlatform(),generateTree(),generateCloud();draw()}function generateCloud(){const t=clouds[clouds.length-1];const e=(t?t.x:0)+60+Math.floor(240*Math.random()),n=60+Math.floor(240*Math.random())-window.innerHeight/1.2,i=Math.floor(15*Math.random()+15);clouds.push({x:e,y:n,w:i})}function generateTree(){const t=trees[trees.length-1];const e=(t?t.x:0)+30+Math.floor(120*Math.random()),n=[colours.lightHill,colours.medBg,colours.medHill][Math.floor(3*Math.random())];trees.push({x:e,color:n})}function generatePlatform(){const t=platforms[platforms.length-1];const e=t.x+t.w+40+Math.floor(160*Math.random()),n=20+Math.floor(80*Math.random());platforms.push({x:e,w:n})}function animate(t){if(!lastTimestamp)return lastTimestamp=t,void window.requestAnimationFrame(animate);switch(_status){case"waiting":return;case"stretching":sticks.last().length+=(t-lastTimestamp)/config.speed;break;case"turning":if(sticks.last().rotation+=(t-lastTimestamp)/config.speed,sticks.last().rotation>90){sticks.last().rotation=90;const[t,e]=thePlatformTheStickHits();t&&(score+=e?2:1,scoreElement.innerText=score,e&&(playJingle(e),perfectElement.style.opacity=1,setTimeout(()=>perfectElement.style.opacity=0,1e3)),generatePlatform(),generateTree(),generateTree(),generateCloud(),generateCloud()),_status="walking"}break;case"walking":{santaX+=(t-lastTimestamp)/config.speed;const[e]=thePlatformTheStickHits();if(e){const t=e.x+e.w-config.santaDistanceFromEdge;santaX>t&&(santaX=t,_status="transitioning")}else{const t=sticks.last().x+sticks.last().length+config.santaWidth;santaX>t&&(santaX=t,_status="falling")}break}case"transitioning":{sceneOffset+=(t-lastTimestamp)/(config.speed/2);const[e]=thePlatformTheStickHits();sceneOffset>e.x+e.w-config.paddingX&&(sticks.push({x:e.x+e.w,length:0,rotation:0}),_status="waiting");break}case"falling":{sticks.last().rotation<180&&(sticks.last().rotation+=(t-lastTimestamp)/config.speed),santaY+=(t-lastTimestamp)/(config.speed/2);const e=config.platformHeight+100+(window.innerHeight-config.canvasHeight)/2;if(santaY>e)return void(restartButton.style.display="block");break}default:throw Error("Wrong _status")}draw(),window.requestAnimationFrame(animate),lastTimestamp=t}function thePlatformTheStickHits(){if(90!=sticks.last().rotation)throw Error(`Stick is ${sticks.last().rotation}¬∞`);const t=sticks.last().x+sticks.last().length,e=platforms.find(e=>e.x<t&&t<e.x+e.w);return e&&e.x+e.w/2-config.perfectAreaSize/2<t&&t<e.x+e.w/2+config.perfectAreaSize/2?[e,!0]:[e,!1]}function draw(){ctx.save(),ctx.clearRect(0,0,window.innerWidth,window.innerHeight),drawBackground(),ctx.translate((window.innerWidth-config.canvasWidth)/2-sceneOffset,(window.innerHeight-config.canvasHeight)/2),drawPlatforms(),drawSanta(),drawSticks(),ctx.restore()}function drawPlatforms(){platforms.forEach(({x:t,w:e})=>{let n=t+3,i=e-6,a=config.platformHeight+(window.innerHeight-config.canvasHeight)/2;ctx.fillStyle=colours.platform,ctx.fillRect(n,config.canvasHeight-config.platformHeight,i,a);for(let t=1;t<=a/10;++t){let e=config.canvasHeight-config.platformHeight+10*t;ctx.moveTo(n,e),ctx.lineTo(n+i,e);let a=t%2?0:10;for(let t=1;t<i/30;++t){let i=20*t+a;ctx.moveTo(n+i,e),ctx.lineTo(n+i,e+10)}ctx.strokeStyle=colours.platformTop,ctx.stroke()}ctx.fillStyle=colours.platformTop,ctx.fillRect(t,config.canvasHeight-config.platformHeight,e,10),sticks.last().x<t&&(ctx.fillStyle="white",ctx.fillRect(t+e/2-config.perfectAreaSize/2,config.canvasHeight-config.platformHeight,config.perfectAreaSize,config.perfectAreaSize))})}function drawSanta(){ctx.save(),ctx.fillStyle="red",ctx.translate(santaX-config.santaWidth/2,santaY+config.canvasHeight-config.platformHeight-config.santaHeight/2),ctx.fillRect(-config.santaWidth/2,-config.santaHeight/2,config.santaWidth,config.santaHeight-4);ctx.beginPath(),ctx.arc(5,11.5,3,0,2*Math.PI,!1),ctx.fill(),ctx.beginPath(),ctx.arc(-5,11.5,3,0,2*Math.PI,!1),ctx.fill(),ctx.beginPath(),ctx.fillStyle=colours.skin,ctx.arc(5,-7,3,0,2*Math.PI,!1),ctx.fill(),ctx.beginPath(),ctx.fillStyle="white",ctx.arc(7,-2,3,0,2*Math.PI,!1),ctx.fill(),ctx.beginPath(),ctx.fillStyle="red",ctx.moveTo(-8,-13.5),ctx.lineTo(-15,-3.5),ctx.lineTo(-5,-7),ctx.fill(),ctx.fillStyle="white",ctx.fillRect(-config.santaWidth/2,-12,config.santaWidth,3),ctx.fillStyle="black",ctx.fillRect(-config.santaWidth/2,2,config.santaWidth,2),ctx.fillStyle="white",ctx.fillRect(-config.santaWidth/2,4,config.santaWidth,4.5),ctx.beginPath(),ctx.fillStyle="white",ctx.arc(-17,-2,3,0,2*Math.PI,!1),ctx.fill(),ctx.restore()}function drawSticks(){sticks.forEach(t=>{ctx.save(),ctx.translate(t.x,config.canvasHeight-config.platformHeight),ctx.rotate(Math.PI/180*t.rotation),ctx.beginPath(),ctx.lineWidth=4,ctx.moveTo(0,0),ctx.lineTo(0,-t.length),ctx.strokeStyle=ctx.createPattern(createCandyPattern(),"repeat"),ctx.stroke(),ctx.restore()})}function drawBackground(){var t=ctx.createRadialGradient(window.innerWidth/2,window.innerHeight/2,0,window.innerHeight/2,window.innerWidth/2,window.innerWidth);t.addColorStop(0,colours.lightBg),t.addColorStop(1,colours.darkBg),ctx.fillStyle=t,ctx.fillRect(0,0,window.innerWidth,window.innerHeight),hills.forEach(t=>drawHill(t.baseHeight,t.amplitude,t.stretch,t.colour)),trees.forEach(t=>drawTree(t.x,t.color)),clouds.forEach(t=>drawCloud(t.x,t.y,t.w))}function drawHill(t,e,n,i){ctx.beginPath(),ctx.moveTo(0,window.innerHeight),ctx.lineTo(0,getHillY(0,t,e,n));for(let i=0;i<window.innerWidth;i++)ctx.lineTo(i,getHillY(i,t,e,n));ctx.lineTo(window.innerWidth,window.innerHeight),ctx.fillStyle=i,ctx.fill()}function drawTree(t,e){ctx.save(),ctx.translate((-sceneOffset*config.backgroundSpeedMultiplier+t)*hills[1].stretch,getTreeY(t,hills[1].baseHeight,hills[1].amplitude));const n=15;ctx.fillStyle=colours.darkHill,ctx.fillRect(-5,-15,10,n),ctx.beginPath(),ctx.moveTo(-15,-45),ctx.lineTo(0,-75),ctx.lineTo(15,-45),ctx.moveTo(-15,-30),ctx.lineTo(0,-67.5),ctx.lineTo(15,-30),ctx.moveTo(-15,-15),ctx.lineTo(0,-45),ctx.lineTo(15,-15),ctx.fillStyle=e,ctx.fill(),ctx.restore()}function drawCloud(t,e,n){ctx.save(),ctx.translate((-sceneOffset*config.backgroundSpeedMultiplier+t)*hills[1].stretch,getTreeY(t,hills[1].baseHeight,hills[1].amplitude));const i=1.5*n;ctx.beginPath(),ctx.arc(t,e,n,.5*Math.PI,1.5*Math.PI),ctx.arc(t+i,e-n,i,1*Math.PI,2*Math.PI),ctx.arc(t+2*i,e-n,i,1.2*Math.PI,Math.PI),ctx.arc(t+3*n,e,n,1.5*Math.PI,.5*Math.PI),ctx.moveTo(t+3*n,e+n),ctx.lineTo(t,e+n),ctx.fillStyle="rgba(255, 255, 255, .3)",ctx.fill(),ctx.restore()}function createCandyPattern(){const t=document.createElement("canvas"),e=t.getContext("2d");let n=0,i=0,a=90;for(;n<15;)e.beginPath(),e.moveTo(0,i),e.lineTo(0,a),e.lineWidth=24,e.strokeStyle="red",e.stroke(),e.beginPath(),e.moveTo(0,i+24),e.lineTo(0,a+24),e.lineWidth=24,e.strokeStyle="white",e.stroke(),i+=48,a+=48,n++;return t}function getHillY(t,e,n,i){const a=window.innerHeight-e;return Math.sinus((sceneOffset*config.backgroundSpeedMultiplier+t)*i)*n+a}function getTreeY(t,e,n){const i=window.innerHeight-e;return Math.sinus(t)*n+i}function createElementStyle(t,e=null,n=null){const i=document.createElement(t);return e&&(i.style.cssText=e),n&&(i.innerHTML=n),document.body.appendChild(i),i}function addShadow(t,e){let n="";for(let i=0;i<=e;i++)n+=`${i}px ${i}px 0 ${t}`,n+=i<e?", ":"";return n}function ensureAudio(){audioCtx||(audioCtx=new(window.AudioContext||window.webkitAudioContext)),"suspended"===audioCtx.state&&audioCtx.resume()}function playJingle(t=!1){ensureAudio();const e=audioCtx.currentTime;(t?[880,1175,1320]:[880,1175]).forEach((t,n)=>{const i=audioCtx.createOscillator(),a=audioCtx.createGain();i.type="sine",i.frequency.value=t;const o=e+.08*n,c=o+.12;a.gain.setValueAtTime(1e-4,o),a.gain.exponentialRampToValueAtTime(.12,o+.01),a.gain.exponentialRampToValueAtTime(1e-4,c),i.connect(a),a.connect(audioCtx.destination),i.start(o),i.stop(c+.02)})}Array.prototype.last=function(){return this[this.length-1]},Math.sinus=function(t){return Math.sin(t/180*Math.PI)},window.addEventListener("keydown",function(t){if(" "==t.key)return t.preventDefault(),void resetGame()}),["mousedown","touchstart"].forEach(function(t){ensureAudio(),window.addEventListener(t,function(t){"waiting"==_status&&(lastTimestamp=void 0,introductionElement.style.opacity=0,_status="stretching",window.requestAnimationFrame(animate))})}),["mouseup","touchend"].forEach(function(t){window.addEventListener(t,function(t){"stretching"==_status&&(_status="turning")})}),window.addEventListener("resize",function(t){canvas.width=window.innerWidth,canvas.height=window.innerHeight,draw()}),restartButton.addEventListener("click",function(t){t.preventDefault(),resetGame(),restartButton.style.display="none"}),window.requestAnimationFrame(animate),resetGame();